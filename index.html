<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>F16 Multiplayer + Chat</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #2c3e50; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* --- GİRİŞ EKRANI --- */
        #loginScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; color: #00ff00;
        }
        #loginScreen h1 {
            font-size: 60px; font-family: 'Arial Black', sans-serif;
            text-shadow: 0 0 20px #00ff00; margin-bottom: 20px; letter-spacing: 3px;
        }
        #usernameInput {
            padding: 15px; font-size: 24px; border: 2px solid #00ff00;
            background: #001100; color: #fff; border-radius: 5px;
            width: 300px; text-align: center; outline: none; font-family: monospace;
        }
        #startBtn {
            margin-top: 20px; padding: 15px 40px; font-size: 24px;
            background: #00ff00; color: #000; border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold; transition: transform 0.2s;
        }
        #startBtn:hover { transform: scale(1.05); box-shadow: 0 0 20px #00ff00; }

        /* --- HUD --- */
        #hud {
            display: none;
            position: absolute; top: 20px; left: 20px; width: 280px; padding: 15px;
            color: #00ff00; background-color: rgba(0, 10, 0, 0.9);
            border: 2px solid #00ff00; border-radius: 10px;
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.15); user-select: none; z-index: 100;
        }
        .panel-header { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0, 255, 0, 0.5); padding-bottom: 8px; margin-bottom: 15px; font-weight: bold; }
        .rec-dot { width: 10px; height: 10px; background: red; border-radius: 50%; display: inline-block; animation: blink 1s infinite; margin-right: 5px; }
        @keyframes blink { 50% { opacity: 0.3; } }
        .score-box { border: 1px solid #00ff00; background: rgba(0, 60, 0, 0.6); padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; margin-bottom: 20px; }
        .score-val { color: #ffd700; font-size: 28px; font-weight: bold; font-family: monospace; }
        .health-track { width: 100%; height: 14px; background: #000; border: 1px solid #004400; margin-bottom: 20px; }
        #healthBar { height: 100%; width: 100%; background: linear-gradient(90deg, #00ff00, #aaff00); transition: width 0.2s ease; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: #000; border: 1px solid #00ff00; padding: 8px; text-align: center; }
        .stat-value { font-size: 22px; font-weight: bold; font-family: monospace; color: #fff; }

        /* --- CHAT SİSTEMİ CSS --- */
        #chatContainer {
            display: none; /* Giriş yapana kadar gizli */
            position: absolute; bottom: 20px; right: 20px;
            width: 320px; height: 250px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff00;
            border-radius: 5px;
            z-index: 100;
            display: flex; flex-direction: column;
        }
        #chatMessages {
            flex: 1; overflow-y: auto; padding: 10px;
            font-size: 13px; color: #ddd; font-family: 'Courier New', monospace;
            scrollbar-width: thin; scrollbar-color: #00ff00 #000;
        }
        #chatMessages::-webkit-scrollbar { width: 5px; }
        #chatMessages::-webkit-scrollbar-thumb { background: #00ff00; }
        .chat-msg { margin-bottom: 5px; word-wrap: break-word; }
        .chat-name { color: #00ff00; font-weight: bold; margin-right: 5px; }
        
        #chatInputWrapper { display: flex; border-top: 1px solid #004400; }
        #chatInput {
            flex: 1; background: transparent; border: none; color: white;
            padding: 8px; font-family: monospace; outline: none;
        }
        #sendBtn {
            background: #004400; color: #00ff00; border: none;
            padding: 0 15px; cursor: pointer; font-weight: bold;
        }
        #sendBtn:hover { background: #00ff00; color: #000; }

        #brand { position: absolute; top: 30px; right: 40px; font-family: 'Arial Black'; font-size: 48px; color: #ffffff; text-shadow: 0 0 25px #00ff00; pointer-events: none; z-index: 100; }
        #damageOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 50%, red 150%); opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 50; }
        #message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff3333; font-family: 'Arial Black'; font-size: 40px; display: none; z-index: 101; background: rgba(0,0,0,0.9); padding: 30px; border: 4px solid red; }
        .score-popup { position: absolute; color: #ffd700; font-weight: bold; font-size: 30px; font-family: 'Arial Black'; text-shadow: 0 0 15px orange; animation: floatUp 1s ease-out forwards; pointer-events: none; z-index: 102; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.2); opacity: 0; } }
    </style>
</head>
<body>
    <!-- GİRİŞ EKRANI -->
    <div id="loginScreen">
        <h1>EGGAPPS F16</h1>
        <input type="text" id="usernameInput" placeholder="PİLOT ADI GİRİN" maxlength="12">
        <button id="startBtn">UÇUŞA BAŞLA</button>
    </div>

    <div id="damageOverlay"></div>
    <div id="message">⚠️ KURTARMA SİSTEMİ DEVREDE</div>
    <div id="brand">Eggapps</div>

    <!-- HUD -->
    <div id="hud">
        <div class="panel-header">
            <span id="pilotNameDisplay">PİLOT PANELİ</span>
            <span style="font-size: 10px; color: #ff5555;"><span class="rec-dot"></span>LIVE</span>
        </div>
        <div class="score-box">
            <span class="score-label">TOPLAM SKOR</span>
            <span class="score-val" id="scoreDisplay">0</span>
        </div>
        <div class="health-label"><span>GÖVDE SAĞLIĞI</span><span id="hpText">100%</span></div>
        <div class="health-track"><div id="healthBar"></div></div>
        <div class="stats-grid">
            <div class="stat-box"><div class="stat-label">HIZ (KM/H)</div><div class="stat-value" id="speedDisplay">0</div></div>
            <div class="stat-box"><div class="stat-label">İRTİFA (M)</div><div class="stat-value" id="altDisplay">0</div></div>
        </div>
    </div>

    <!-- CHAT KUTUSU -->
    <div id="chatContainer" style="display: none;">
        <div id="chatMessages">
            <div class="chat-msg" style="color: yellow;">Sistem: Telsiz bağlantısı kuruldu...</div>
        </div>
        <div id="chatInputWrapper">
            <input type="text" id="chatInput" placeholder="Mesaj yaz... (Enter)" autocomplete="off">
            <button id="sendBtn">YOL</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script type="module">
        // --- FIREBASE IMPORTLARI (push ve child_added eklendi) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onDisconnect, onValue, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyConJs82OWJReQWyyyWr00NTdBH9lAsEtQ",
            authDomain: "laf-sokucuu.firebaseapp.com",
            databaseURL: "https://laf-sokucuu-default-rtdb.firebaseio.com",
            projectId: "laf-sokucuu",
            storageBucket: "laf-sokucuu.firebasestorage.app",
            messagingSenderId: "943728190079",
            appId: "1:943728190079:web:0a94e6b9ddb19bd6c9954a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- OYUN DEĞİŞKENLERİ ---
        let gameActive = false;
        let myPlayerId = null;
        let myName = "Pilot";
        let playerRef = null;
        const otherPlayers = {}; 

        // --- 1. SAHNE KURULUMU ---
        const scene = new THREE.Scene();
        const darkSkyColor = 0x2c3e50; 
        scene.background = new THREE.Color(darkSkyColor);
        scene.fog = new THREE.Fog(darkSkyColor, 200, 4000); 

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.5); 
        scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); 
        dirLight.position.set(200, 500, 300);
        dirLight.castShadow = true;
        scene.add(dirLight);

        const ground = new THREE.Mesh(new THREE.PlaneGeometry(60000, 60000), new THREE.MeshPhongMaterial({ color: 0x1a1a1a }));
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);
        const grid = new THREE.GridHelper(60000, 600, 0x000000, 0x222222);
        grid.position.y = 0.2;
        scene.add(grid);

        // --- 2. BİNALAR ---
        const buildingBoxes = []; 
        const buildingGeometry = new THREE.BoxGeometry(1, 1, 1);
        const mat1 = new THREE.MeshPhongMaterial({ color: 0x2c3e50 }); 
        const mat2 = new THREE.MeshPhongMaterial({ color: 0x151515 }); 
        const mat3 = new THREE.MeshPhongMaterial({ color: 0x34495e }); 

        for(let i=0; i<1500; i++) {
            const w = 40 + Math.random() * 60;
            const h = 100 + Math.random() * 500;
            const d = 40 + Math.random() * 60;
            let mat = mat1;
            if(Math.random() > 0.6) mat = mat2; else if(Math.random() > 0.3) mat = mat3;
            const building = new THREE.Mesh(buildingGeometry, mat);
            building.scale.set(w, h, d);
            let x = (Math.random() - 0.5) * 9000; 
            let z = (Math.random() - 0.5) * 9000;
            if(Math.abs(x) < 600 && Math.abs(z) < 3000) x += 1200; 
            building.position.set(x, h/2, z);
            building.castShadow = true;
            building.updateMatrixWorld(); 
            buildingBoxes.push(new THREE.Box3().setFromObject(building));
            scene.add(building);
        }

        // --- 3. PUAN KÜRELERİ ---
        let score = 0;
        const collectables = [];
        const collectableGeo = new THREE.IcosahedronGeometry(6, 2);
        const collectableMat = new THREE.MeshPhongMaterial({ color: 0xFFD700, emissive: 0xFFAA00, emissiveIntensity: 0.8 });

        function spawnCollectable() {
            let valid = false, tempPos = new THREE.Vector3(), attempts=0;
            while (!valid && attempts < 50) {
                attempts++;
                tempPos.set((Math.random()-0.5)*8000, 50+Math.random()*500, (Math.random()-0.5)*8000);
                let testBox = new THREE.Box3().setFromCenterAndSize(tempPos, new THREE.Vector3(30,30,30));
                if(!buildingBoxes.some(b => testBox.intersectsBox(b))) valid = true;
            }
            if(valid) {
                const mesh = new THREE.Mesh(collectableGeo, collectableMat);
                mesh.position.copy(tempPos);
                mesh.scale.setScalar(1.5 + Math.random() * 1.5);
                mesh.userData = { points: 100 };
                scene.add(mesh);
                collectables.push(mesh);
            }
        }
        for(let i=0; i<100; i++) spawnCollectable();
        setInterval(spawnCollectable, 5000);

        function showScorePopup(points) {
            const div = document.createElement('div');
            div.className = 'score-popup'; div.innerText = "+" + points;
            div.style.left = (window.innerWidth/2 - 50 + Math.random()*100) + 'px';
            div.style.top = (window.innerHeight/2 - 100) + 'px';
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }

        // --- 4. UÇAK MODELLERİ ---
        function createPlaneMesh(bodyColor, wingColor) {
            const grp = new THREE.Group();
            const body = new THREE.Mesh(new THREE.ConeGeometry(1.5, 18, 32), new THREE.MeshStandardMaterial({ color: bodyColor, roughness: 0.3 }));
            body.rotation.x = -Math.PI / 2; grp.add(body);
            const wings = new THREE.Mesh(new THREE.BoxGeometry(16, 0.4, 8), new THREE.MeshStandardMaterial({ color: wingColor, roughness: 0.3 }));
            wings.position.z = 2; grp.add(wings);
            const tail = new THREE.Mesh(new THREE.BoxGeometry(6, 0.4, 4), new THREE.MeshStandardMaterial({ color: wingColor }));
            tail.position.set(0, 0, 7); grp.add(tail);
            const vTail = new THREE.Mesh(new THREE.BoxGeometry(0.4, 5, 4), new THREE.MeshStandardMaterial({ color: wingColor }));
            vTail.position.set(0, 2, 7); grp.add(vTail);
            return grp;
        }

        const planeGroup = createPlaneMesh(0x78909c, 0x546e7a);
        const cockpit = new THREE.Mesh(new THREE.SphereGeometry(1.2, 16, 16), new THREE.MeshPhongMaterial({ color: 0x000000 }));
        cockpit.position.set(0, 1.2, -2); cockpit.scale.set(1, 0.6, 2.5); planeGroup.add(cockpit);
        
        const flame = new THREE.Mesh(new THREE.ConeGeometry(1, 6, 16), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
        flame.rotation.x = Math.PI / 2; flame.position.z = 11; flame.visible = false; planeGroup.add(flame);
        
        scene.add(planeGroup);
        planeGroup.position.set(0, 2, 0);
        planeGroup.rotation.order = 'YXZ';
        const playerBox = new THREE.Box3();

        // --- CHAT FONKSİYONLARI ---
        const chatRef = ref(db, 'chat');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');

        function sendMessage() {
            const text = chatInput.value.trim();
            if (text !== "") {
                push(chatRef, {
                    sender: myName,
                    text: text,
                    timestamp: Date.now()
                });
                chatInput.value = "";
            }
        }

        // Gönder butonuna basınca
        document.getElementById('sendBtn').addEventListener('click', sendMessage);

        // Enter tuşuna basınca (Ve olay yayılmasını durdur)
        chatInput.addEventListener('keydown', (e) => {
            e.stopPropagation(); // Bu tuşu oyun algılamasın
            if (e.key === 'Enter') sendMessage();
        });

        // Mesaj geldiğinde
        const recentMessagesQuery = query(chatRef, limitToLast(20));
        onChildAdded(recentMessagesQuery, (snapshot) => {
            const msg = snapshot.val();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-msg';
            msgDiv.innerHTML = `<span class="chat-name">${msg.sender}:</span> ${msg.text}`;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // En alta kaydır
        });

        // --- GİRİŞ SİSTEMİ ---
        document.getElementById('startBtn').addEventListener('click', () => {
            const inputVal = document.getElementById('usernameInput').value;
            if(!inputVal.trim()) { alert("İsim yazmadan uçamazsın!"); return; }
            
            myName = inputVal;
            myPlayerId = 'pilot_' + Math.random().toString(36).substr(2, 5);
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('chatContainer').style.display = 'flex'; // Chat'i aç
            document.getElementById('pilotNameDisplay').innerText = myName.toUpperCase() + " (SEN)";
            
            playerRef = ref(db, 'players/' + myPlayerId);
            onDisconnect(playerRef).remove();
            
            // Diğer Oyuncuları İzle
            const allPlayersRef = ref(db, 'players');
            onValue(allPlayersRef, (snapshot) => {
                const players = snapshot.val() || {};
                
                Object.keys(players).forEach((key) => {
                    if (key === myPlayerId) return;
                    const pData = players[key];
                    if (!otherPlayers[key]) {
                        const enemyPlane = createPlaneMesh(0xff0000, 0x880000);
                        scene.add(enemyPlane);
                        otherPlayers[key] = enemyPlane;
                    }
                    const enemy = otherPlayers[key];
                    enemy.position.set(pData.x, pData.y, pData.z);
                    enemy.rotation.set(pData.rx, pData.ry, pData.rz);
                });

                Object.keys(otherPlayers).forEach((key) => {
                    if (!players[key]) {
                        scene.remove(otherPlayers[key]);
                        delete otherPlayers[key];
                    }
                });
            });

            gameActive = true;
            animate();
        });

        // --- 5. OYUN MANTIĞI ---
        let health = 100;
        let lastDamageTime = 0;
        let speed = 0;
        const keys = { w: false, up: false, down: false, left: false, right: false };
        const maxSpeed = 12.0, liftSpeed = 3.0;

        function resetGame() {
            planeGroup.position.set(0, 2, 0); planeGroup.rotation.set(0, 0, 0);
            speed = 0; health = 100; score = 0;
            document.getElementById('scoreDisplay').innerText = 0;
            updateHealthUI();
            alert("DÜŞTÜNÜZ! YENİDEN BAŞLATILIYOR...");
        }

        function takeDamage(amount) {
            health -= amount; lastDamageTime = Date.now();
            document.getElementById('damageOverlay').style.opacity = 0.8;
            setTimeout(() => document.getElementById('damageOverlay').style.opacity = 0, 200);
            updateHealthUI();
            if(health <= 0) resetGame();
        }

        function updateHealthUI() {
            document.getElementById('hpText').innerText = Math.round(health) + "%";
            document.getElementById('healthBar').style.width = health + "%";
            const bar = document.getElementById('healthBar');
            if(health > 50) bar.style.background = "linear-gradient(90deg, #00ff00, #aaff00)";
            else if(health > 20) bar.style.background = "linear-gradient(90deg, #ffa500, #ffcc00)";
            else bar.style.background = "linear-gradient(90deg, #ff0000, #ff5500)";
        }

        // --- TUŞ KONTROLLERİ (CHAT ODAKLIYKEN ÇALIŞMAZ) ---
        document.addEventListener('keydown', (e) => {
            // Eğer chat kutusuna yazıyorsak, uçak kontrollerini engelle
            if (document.activeElement === chatInput) return;

            if(e.key === 'w' || e.key === 'W') keys.w = true;
            if(e.key === 'ArrowUp') keys.up = true;
            if(e.key === 'ArrowDown') keys.down = true;
            if(e.key === 'ArrowLeft') keys.left = true;
            if(e.key === 'ArrowRight') keys.right = true;
        });

        document.addEventListener('keyup', (e) => {
            if(e.key === 'w' || e.key === 'W') keys.w = false;
            if(e.key === 'ArrowUp') keys.up = false;
            if(e.key === 'ArrowDown') keys.down = false;
            if(e.key === 'ArrowLeft') keys.left = false;
            if(e.key === 'ArrowRight') keys.right = false;
        });

        // --- 6. ANA DÖNGÜ ---
        let frameCount = 0;

        function animate() {
            if(!gameActive) return;
            requestAnimationFrame(animate);

            if (health > 0 && health < 100 && Date.now() - lastDamageTime > 10000) {
                health += 0.1; updateHealthUI();
            }

            if (keys.w) { speed += 0.08; flame.visible = true; flame.scale.setScalar(0.8+Math.random()*0.4); }
            else { flame.visible = false; speed -= 0.005; }
            if(speed > maxSpeed) speed = maxSpeed; if(speed < 0) speed = 0;

            const oldPosition = planeGroup.position.clone();
            planeGroup.translateZ(-speed);

            frameCount++;
            if(frameCount % 3 === 0 && playerRef) {
                set(playerRef, {
                    name: myName,
                    x: planeGroup.position.x,
                    y: planeGroup.position.y,
                    z: planeGroup.position.z,
                    rx: planeGroup.rotation.x,
                    ry: planeGroup.rotation.y,
                    rz: planeGroup.rotation.z,
                });
            }

            for (let i = collectables.length - 1; i >= 0; i--) {
                const item = collectables[i];
                item.rotation.x += 0.02;
                const dist = planeGroup.position.distanceTo(item.position);
                if (dist < 25) {
                    score += item.userData.points;
                    document.getElementById('scoreDisplay').innerText = score;
                    showScorePopup(item.userData.points);
                    scene.remove(item); collectables.splice(i, 1);
                }
            }

            playerBox.setFromObject(planeGroup).expandByScalar(-1.0);
            if (planeGroup.position.y < 600) { 
                for (let box of buildingBoxes) {
                    if (playerBox.intersectsBox(box)) {
                        takeDamage(20);
                        planeGroup.position.copy(oldPosition);
                        planeGroup.translateZ(30); planeGroup.position.y += 150; planeGroup.rotation.set(0,0,0);
                        if (speed < liftSpeed) speed = liftSpeed;
                        const msg = document.getElementById('message');
                        msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2000);
                        break;
                    }
                }
            }

            if (speed > 0.5 && health > 0) {
                if(keys.up && planeGroup.rotation.x < 1.0) planeGroup.rotation.x += 0.02;
                if(keys.down && planeGroup.rotation.x > -1.0) planeGroup.rotation.x -= 0.02;
                if (keys.left) { planeGroup.rotateY(0.015); if (planeGroup.rotation.z < 0.8) planeGroup.rotation.z += 0.03; } 
                else if (keys.right) { planeGroup.rotateY(-0.015); if (planeGroup.rotation.z > -0.8) planeGroup.rotation.z -= 0.03; } 
                else {
                    if (planeGroup.rotation.z > 0.005) planeGroup.rotation.z -= 0.015;
                    else if (planeGroup.rotation.z < -0.005) planeGroup.rotation.z += 0.015;
                }
            }

            if (planeGroup.position.y > 2) {
                if (speed < liftSpeed) {
                    planeGroup.position.y -= 1.5 * (1 - speed/liftSpeed);
                    if(planeGroup.rotation.x > -0.5) planeGroup.rotation.x -= 0.01;
                }
            } else {
                if (planeGroup.position.y <= 2) {
                    planeGroup.position.y = 2;
                    if (planeGroup.rotation.x < -0.2) { takeDamage(10); speed = 0; }
                    if(speed < liftSpeed) { planeGroup.rotation.z *= 0.9; planeGroup.rotation.x *= 0.9; }
                }
            }

            const targetPos = new THREE.Vector3(0, 12, 45).applyMatrix4(planeGroup.matrixWorld);
            camera.position.lerp(targetPos, 0.1);
            camera.lookAt(new THREE.Vector3(0, 0, -60).applyMatrix4(planeGroup.matrixWorld));

            document.getElementById('speedDisplay').innerText = Math.floor(speed * 120);
            document.getElementById('altDisplay').innerText = Math.floor(planeGroup.position.y - 2);
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
