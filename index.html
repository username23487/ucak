<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F16 Final - Stable Physics & UI</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #2c3e50; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        
        /* --- GİRİŞ EKRANI --- */
        #loginScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; color: #00ff00;
        }
        #loginScreen h1 {
            font-size: 60px; font-family: 'Arial Black', sans-serif;
            text-shadow: 0 0 20px #00ff00; margin-bottom: 20px; letter-spacing: 3px; text-align: center;
        }
        #usernameInput {
            padding: 15px; font-size: 24px; border: 2px solid #00ff00;
            background: #001100; color: #fff; border-radius: 5px;
            width: 300px; text-align: center; outline: none; font-family: monospace;
        }
        #startBtn {
            margin-top: 20px; padding: 15px 40px; font-size: 24px;
            background: #00ff00; color: #000; border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold; transition: transform 0.2s;
        }
        #startBtn:hover { transform: scale(1.05); box-shadow: 0 0 20px #00ff00; }

        /* --- ÖZEL GAME OVER EKRANI (Alert yerine) --- */
        #gameOverScreen {
            display: none;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50, 0, 0, 0.8);
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 10000; color: white;
            backdrop-filter: blur(5px);
        }
        #gameOverScreen h2 {
            font-size: 40px; font-family: 'Arial Black'; color: #ff3333; text-shadow: 0 0 20px red;
            margin-bottom: 10px;
        }
        #restartBtn {
            padding: 20px 50px; font-size: 24px; background: #ff0000; color: white;
            border: 2px solid white; border-radius: 10px; cursor: pointer; font-weight: bold;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
        }
        #restartBtn:active { transform: scale(0.95); }

        /* --- TAM EKRAN BUTONU --- */
        #fullscreenBtn {
            position: absolute; top: 20px; right: 20px;
            width: 40px; height: 40px;
            background: rgba(0, 0, 0, 0.5); border: 1px solid #00ff00; color: #00ff00;
            font-size: 24px; line-height: 40px; text-align: center;
            cursor: pointer; z-index: 200; border-radius: 5px;
        }

        /* --- HUD --- */
        #hud {
            display: none;
            position: absolute; top: 20px; left: 20px; width: 280px; padding: 15px;
            color: #00ff00; background-color: rgba(0, 10, 0, 0.9);
            border: 2px solid #00ff00; border-radius: 10px;
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.15); user-select: none; z-index: 100;
        }
        .panel-header { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0, 255, 0, 0.5); padding-bottom: 8px; margin-bottom: 15px; font-weight: bold; }
        .rec-dot { width: 10px; height: 10px; background: red; border-radius: 50%; display: inline-block; animation: blink 1s infinite; margin-right: 5px; }
        @keyframes blink { 50% { opacity: 0.3; } }
        .score-box { border: 1px solid #00ff00; background: rgba(0, 60, 0, 0.6); padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; margin-bottom: 20px; }
        .score-val { color: #ffd700; font-size: 28px; font-weight: bold; font-family: monospace; }
        .health-track { width: 100%; height: 14px; background: #000; border: 1px solid #004400; margin-bottom: 20px; }
        #healthBar { height: 100%; width: 100%; background: linear-gradient(90deg, #00ff00, #aaff00); transition: width 0.2s ease; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: #000; border: 1px solid #00ff00; padding: 8px; text-align: center; }
        .stat-value { font-size: 22px; font-weight: bold; font-family: monospace; color: #fff; }

        /* --- RADAR / GPS --- */
        #radarContainer {
            display: none;
            position: absolute; top: 80px; right: 20px;
            width: 150px; height: 150px;
            background: rgba(0, 10, 0, 0.85);
            border: 2px solid #00ff00;
            border-radius: 50%;
            z-index: 100;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
            overflow: hidden;
        }
        #radarCanvas { width: 100%; height: 100%; }
        .radar-label {
            position: absolute; bottom: 5px; width: 100%; text-align: center;
            font-size: 10px; color: #00ff00; font-weight: bold; pointer-events: none;
        }

        /* --- İZLEME BUTONU --- */
        #spectateControl {
            display: none;
            position: absolute; top: 240px; right: 20px;
            z-index: 101;
        }
        #camBtn {
            background: rgba(0, 20, 0, 0.9); color: #00ff00; border: 1px solid #00ff00;
            padding: 8px 15px; cursor: pointer; font-family: monospace; font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2); transition: all 0.2s;
        }
        #camBtn:hover { background: #00ff00; color: #000; }

        /* --- CHAT --- */
        #chatContainer {
            display: none;
            position: absolute; bottom: 20px; right: 20px;
            width: 320px; height: 250px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff00;
            border-radius: 5px;
            z-index: 100;
            display: flex; flex-direction: column;
        }
        #chatMessages { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; color: #ddd; font-family: 'Courier New', monospace; }
        .chat-msg { margin-bottom: 5px; word-wrap: break-word; }
        .chat-name { color: #00ff00; font-weight: bold; margin-right: 5px; }
        #chatInputWrapper { display: flex; border-top: 1px solid #004400; }
        #chatInput { flex: 1; background: transparent; border: none; color: white; padding: 8px; font-family: monospace; outline: none; }
        #sendBtn { background: #004400; color: #00ff00; border: none; padding: 0 15px; cursor: pointer; font-weight: bold; }

        /* --- PC KONTROL BİLGİSİ --- */
        #pcControls {
            display: none;
            position: absolute;
            top: 50%; left: 20px; transform: translateY(-50%);
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #00ff00;
            padding: 15px; border-radius: 10px;
            color: #00ff00; font-family: monospace;
            z-index: 90;
            pointer-events: none;
        }
        #pcControls h3 { border-bottom: 1px solid #00ff00; padding-bottom: 5px; margin-top: 0; }
        .key-row { margin-bottom: 5px; }
        .key { border: 1px solid #fff; padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; }

        /* --- MOBİL KONTROLLER (DİNAMİK JOYSTICK) --- */
        #mobileControls {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 150; pointer-events: none;
        }
        #touchZoneLeft {
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            pointer-events: auto;
        }
        #dynamicJoystick {
            display: none;
            position: absolute;
            width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 0, 0.5);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
        }
        #dynamicKnob {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px;
            background: rgba(0, 255, 0, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px #00ff00;
        }
        #throttleBtn {
            position: absolute; bottom: 60px; right: 40px;
            width: 100px; height: 100px;
            background: rgba(255, 0, 0, 0.2);
            border: 3px solid #ff0000;
            border-radius: 50%;
            color: white; font-weight: bold; font-family: monospace; font-size: 18px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: auto;
            user-select: none;
        }
        #throttleBtn:active { background: rgba(255, 0, 0, 0.6); box-shadow: 0 0 20px red; }

        /* --- DİĞER --- */
        #brand { position: absolute; top: 30px; right: 220px; font-family: 'Arial Black'; font-size: 36px; color: #ffffff; text-shadow: 0 0 25px #00ff00; pointer-events: none; z-index: 100; opacity: 0.5; }
        #damageOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 50%, red 150%); opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 50; }
        #message {
            position: absolute; top: 150px; right: 220px; width: 200px;
            color: #ff3333; font-family: 'Arial Black', sans-serif; font-size: 14px;
            text-shadow: 0 0 5px #000; display: none; z-index: 101;
            background: rgba(0, 0, 0, 0.8); padding: 15px; border: 2px solid red; border-radius: 5px; text-align: center;
        }
        .score-popup { position: absolute; color: #ffd700; font-weight: bold; font-size: 30px; font-family: 'Arial Black'; text-shadow: 0 0 15px orange; animation: floatUp 1s ease-out forwards; pointer-events: none; z-index: 102; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.2); opacity: 0; } }
    </style>
</head>
<body>
    <!-- GİRİŞ EKRANI -->
    <div id="loginScreen">
        <h1>EGGAPPS F16</h1>
        <input type="text" id="usernameInput" placeholder="PİLOT ADI GİRİN" maxlength="12">
        <button id="startBtn">UÇUŞA BAŞLA</button>
    </div>

    <!-- GAME OVER EKRANI (Alert Yerine) -->
    <div id="gameOverScreen">
        <h2>KAZA RAPORU</h2>
        <h3 style="color:white; margin-top:0;">UÇAK PARÇALANDI</h3>
        <button id="restartBtn">YENİDEN KALKIŞ YAP</button>
    </div>

    <!-- TAM EKRAN BUTONU -->
    <div id="fullscreenBtn">⛶</div>

    <div id="damageOverlay"></div>
    <div id="message">⚠️ KURTARMA SİSTEMİ<br><span style="font-size:10px; color:white;">YENİDEN KONUMLANDIRILIYOR</span></div>
    <div id="brand">Eggapps</div>

    <div id="radarContainer">
        <canvas id="radarCanvas" width="180" height="180"></canvas>
        <div class="radar-label">GPS RADAR</div>
    </div>

    <div id="spectateControl">
        <button id="camBtn">KAMERA: SEN</button>
    </div>

    <div id="pcControls">
        <h3>KONTROLLER</h3>
        <div class="key-row"><span class="key">W</span> : GAZ (SPEED)</div>
        <div class="key-row"><span class="key">▲</span> : YÜKSEL</div>
        <div class="key-row"><span class="key">▼</span> : ALÇAL</div>
        <div class="key-row"><span class="key">◄</span> : SOLA DÖN</div>
        <div class="key-row"><span class="key">►</span> : SAĞA DÖN</div>
        <div class="key-row"><span class="key">C</span> : KAMERA</div>
        <div class="key-row"><span class="key">ENTER</span> : CHAT</div>
    </div>

    <!-- MOBİL KONTROLLER -->
    <div id="mobileControls">
        <div id="touchZoneLeft"></div>
        <div id="dynamicJoystick">
            <div id="dynamicKnob"></div>
        </div>
        <div id="throttleBtn">GAZ</div>
    </div>

    <div id="hud">
        <div class="panel-header">
            <span id="pilotNameDisplay">PİLOT PANELİ</span>
            <span style="font-size: 10px; color: #ff5555;"><span class="rec-dot"></span>LIVE</span>
        </div>
        <div class="score-box">
            <span class="score-label">TOPLAM SKOR</span>
            <span class="score-val" id="scoreDisplay">0</span>
        </div>
        <div class="health-label"><span>GÖVDE SAĞLIĞI</span><span id="hpText">100%</span></div>
        <div class="health-track"><div id="healthBar"></div></div>
        <div class="stats-grid">
            <div class="stat-box"><div class="stat-label">HIZ (KM/H)</div><div class="stat-value" id="speedDisplay">0</div></div>
            <div class="stat-box"><div class="stat-label">İRTİFA (M)</div><div class="stat-value" id="altDisplay">0</div></div>
        </div>
    </div>

    <div id="chatContainer">
        <div id="chatMessages">
            <div class="chat-msg" style="color: yellow;">Sistem: Motorlar hazır...</div>
        </div>
        <div id="chatInputWrapper">
            <input type="text" id="chatInput" placeholder="Mesaj yaz... (Enter)" autocomplete="off">
            <button id="sendBtn">YOL</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onDisconnect, onValue, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyConJs82OWJReQWyyyWr00NTdBH9lAsEtQ",
            authDomain: "laf-sokucuu.firebaseapp.com",
            databaseURL: "https://laf-sokucuu-default-rtdb.firebaseio.com",
            projectId: "laf-sokucuu",
            storageBucket: "laf-sokucuu.firebasestorage.app",
            messagingSenderId: "943728190079",
            appId: "1:943728190079:web:0a94e6b9ddb19bd6c9954a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let gameActive = false;
        let myPlayerId = null;
        let myName = "Pilot";
        let playerRef = null;
        const otherPlayers = {}; 
        let playersDataCache = {}; 
        let spectateId = null;

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const clock = new THREE.Clock(); // DELTA TIME İÇİN

        const scene = new THREE.Scene();
        const darkSkyColor = 0x2c3e50; 
        scene.background = new THREE.Color(darkSkyColor);
        scene.fog = new THREE.Fog(darkSkyColor, 200, 4000); 

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.5); 
        scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); 
        dirLight.position.set(200, 500, 300);
        dirLight.castShadow = true;
        scene.add(dirLight);

        const ground = new THREE.Mesh(new THREE.PlaneGeometry(60000, 60000), new THREE.MeshPhongMaterial({ color: 0x1a1a1a }));
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);
        const grid = new THREE.GridHelper(60000, 600, 0x000000, 0x222222);
        grid.position.y = 0.2;
        scene.add(grid);

        const buildingBoxes = []; 
        const buildingGeometry = new THREE.BoxGeometry(1, 1, 1);
        const mat1 = new THREE.MeshPhongMaterial({ color: 0x2c3e50 }); 
        const mat2 = new THREE.MeshPhongMaterial({ color: 0x151515 }); 
        const mat3 = new THREE.MeshPhongMaterial({ color: 0x34495e }); 

        const BUILDING_COUNT = 3000; 
        for(let i=0; i<BUILDING_COUNT; i++) {
            const w = 40 + Math.random() * 60;
            const h = 100 + Math.random() * 500;
            const d = 40 + Math.random() * 60;
            let mat = mat1;
            if(Math.random() > 0.6) mat = mat2; else if(Math.random() > 0.3) mat = mat3;
            const building = new THREE.Mesh(buildingGeometry, mat);
            building.scale.set(w, h, d);
            let x = (Math.random() - 0.5) * 9000; 
            let z = (Math.random() - 0.5) * 9000;
            if(Math.abs(x) < 600 && Math.abs(z) < 3000) x += 1200; 
            building.position.set(x, h/2, z);
            building.castShadow = true;
            building.updateMatrixWorld(); 
            buildingBoxes.push(new THREE.Box3().setFromObject(building));
            scene.add(building);
        }

        let score = 0;
        const collectables = [];
        const collectableGeo = new THREE.IcosahedronGeometry(6, 2);
        const collectableMat = new THREE.MeshPhongMaterial({ color: 0xFFD700, emissive: 0xFFAA00, emissiveIntensity: 0.8 });

        function spawnCollectable() {
            let valid = false, tempPos = new THREE.Vector3(), attempts=0;
            while (!valid && attempts < 50) {
                attempts++;
                tempPos.set((Math.random()-0.5)*8000, 50+Math.random()*500, (Math.random()-0.5)*8000);
                let testBox = new THREE.Box3().setFromCenterAndSize(tempPos, new THREE.Vector3(30,30,30));
                if(!buildingBoxes.some(b => testBox.intersectsBox(b))) valid = true;
            }
            if(valid) {
                const mesh = new THREE.Mesh(collectableGeo, collectableMat);
                mesh.position.copy(tempPos);
                mesh.scale.setScalar(1.5 + Math.random() * 1.5);
                mesh.userData = { points: 100 };
                scene.add(mesh);
                collectables.push(mesh);
            }
        }
        for(let i=0; i<100; i++) spawnCollectable();
        setInterval(spawnCollectable, 5000);

        function showScorePopup(points) {
            const div = document.createElement('div');
            div.className = 'score-popup'; div.innerText = "+" + points;
            div.style.left = (window.innerWidth/2 - 50 + Math.random()*100) + 'px';
            div.style.top = (window.innerHeight/2 - 100) + 'px';
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }

        function createPlaneMesh(bodyColor, wingColor) {
            const grp = new THREE.Group();
            const body = new THREE.Mesh(new THREE.ConeGeometry(1.5, 18, 32), new THREE.MeshStandardMaterial({ color: bodyColor, roughness: 0.3 }));
            body.rotation.x = -Math.PI / 2; grp.add(body);
            const wings = new THREE.Mesh(new THREE.BoxGeometry(16, 0.4, 8), new THREE.MeshStandardMaterial({ color: wingColor, roughness: 0.3 }));
            wings.position.z = 2; grp.add(wings);
            const tail = new THREE.Mesh(new THREE.BoxGeometry(6, 0.4, 4), new THREE.MeshStandardMaterial({ color: wingColor }));
            tail.position.set(0, 0, 7); grp.add(tail);
            const vTail = new THREE.Mesh(new THREE.BoxGeometry(0.4, 5, 4), new THREE.MeshStandardMaterial({ color: wingColor }));
            vTail.position.set(0, 2, 7); grp.add(vTail);
            return grp;
        }

        const planeGroup = createPlaneMesh(0x78909c, 0x546e7a);
        const cockpit = new THREE.Mesh(new THREE.SphereGeometry(1.2, 16, 16), new THREE.MeshPhongMaterial({ color: 0x000000 }));
        cockpit.position.set(0, 1.2, -2); cockpit.scale.set(1, 0.6, 2.5); planeGroup.add(cockpit);
        
        const flame = new THREE.Mesh(new THREE.ConeGeometry(1, 6, 16), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
        flame.rotation.x = Math.PI / 2; flame.position.z = 11; flame.visible = false; planeGroup.add(flame);
        
        scene.add(planeGroup);
        planeGroup.position.set(0, 2, 0);
        planeGroup.rotation.order = 'YXZ';
        const playerBox = new THREE.Box3();

        // --- TAM EKRAN BUTONU ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullScreen);

        // --- İZLEME SİSTEMİ ---
        function toggleCamera() {
            const availablePlayers = [null, ...Object.keys(otherPlayers)];
            let currentIndex = availablePlayers.indexOf(spectateId);
            if (currentIndex === -1) currentIndex = 0;
            let nextIndex = (currentIndex + 1) % availablePlayers.length;
            spectateId = availablePlayers[nextIndex];

            const btn = document.getElementById('camBtn');
            if (spectateId === null) {
                btn.innerText = "KAMERA: SEN";
                btn.style.borderColor = "#00ff00";
            } else {
                let targetName = "PİLOT";
                if(playersDataCache[spectateId] && playersDataCache[spectateId].name) {
                    targetName = playersDataCache[spectateId].name;
                }
                btn.innerText = "İZLENİYOR: " + targetName;
                btn.style.borderColor = "#ff0000";
            }
        }
        document.getElementById('camBtn').addEventListener('click', toggleCamera);
        document.addEventListener('keydown', (e) => {
             if (document.activeElement !== chatInput && (e.key === 'c' || e.key === 'C')) {
                 toggleCamera();
             }
        });

        // --- RADAR ---
        const radarCanvas = document.getElementById('radarCanvas');
        const radarCtx = radarCanvas.getContext('2d');
        const RADAR_RANGE = 5000;

        function drawRadar() {
            radarCtx.clearRect(0, 0, radarCanvas.width, radarCanvas.height);
            const cw = radarCanvas.width;
            const ch = radarCanvas.height;
            const cx = cw / 2;
            const cy = ch / 2;

            radarCtx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
            radarCtx.lineWidth = 1;
            radarCtx.beginPath(); radarCtx.arc(cx, cy, cw/2 - 2, 0, Math.PI*2); radarCtx.stroke();
            radarCtx.beginPath(); radarCtx.arc(cx, cy, cw/4, 0, Math.PI*2); radarCtx.stroke();
            radarCtx.beginPath(); radarCtx.moveTo(0, cy); radarCtx.lineTo(cw, cy); radarCtx.stroke();
            radarCtx.beginPath(); radarCtx.moveTo(cx, 0); radarCtx.lineTo(cx, ch); radarCtx.stroke();

            radarCtx.save();
            radarCtx.translate(cx, cy);
            
            let currentRotY = planeGroup.rotation.y;
            if(spectateId && otherPlayers[spectateId]) {
                currentRotY = otherPlayers[spectateId].userData.targetRot ? new THREE.Euler().setFromQuaternion(otherPlayers[spectateId].quaternion).y : otherPlayers[spectateId].rotation.y;
            }
            radarCtx.rotate(-currentRotY); 

            radarCtx.fillStyle = '#00ff00';
            radarCtx.beginPath();
            radarCtx.moveTo(0, -7); radarCtx.lineTo(5, 5); radarCtx.lineTo(-5, 5); 
            radarCtx.closePath(); radarCtx.fill();
            radarCtx.restore();

            let centerPos = planeGroup.position;
            if(spectateId && otherPlayers[spectateId]) {
                centerPos = otherPlayers[spectateId].position;
            }

            if(spectateId) {
                const dx = planeGroup.position.x - centerPos.x;
                const dz = planeGroup.position.z - centerPos.z;
                const mapX = cx + (dx / RADAR_RANGE) * (cw/2);
                const mapY = cy + (dz / RADAR_RANGE) * (ch/2);
                if (mapX > 0 && mapX < cw && mapY > 0 && mapY < ch) {
                    radarCtx.fillStyle = '#ff0000';
                    radarCtx.beginPath(); radarCtx.arc(mapX, mapY, 4, 0, Math.PI*2); radarCtx.fill();
                }
            }

            Object.keys(otherPlayers).forEach(key => {
                if(key === spectateId) return; 

                const enemy = otherPlayers[key];
                const dx = enemy.position.x - centerPos.x;
                const dz = enemy.position.z - centerPos.z;
                const mapX = cx + (dx / RADAR_RANGE) * (cw/2);
                const mapY = cy + (dz / RADAR_RANGE) * (ch/2);
                if (mapX > 0 && mapX < cw && mapY > 0 && mapY < ch) {
                    radarCtx.fillStyle = '#ff0000';
                    radarCtx.beginPath(); radarCtx.arc(mapX, mapY, 4, 0, Math.PI*2); radarCtx.fill();
                }
            });
        }

        // CHAT
        const chatRef = ref(db, 'chat');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');

        function sendMessage() {
            const text = chatInput.value.trim();
            if (text !== "") {
                push(chatRef, { sender: myName, text: text });
                chatInput.value = "";
            }
        }
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            e.stopPropagation();
            if (e.key === 'Enter') sendMessage();
        });
        const recentMessagesQuery = query(chatRef, limitToLast(20));
        onChildAdded(recentMessagesQuery, (snapshot) => {
            const msg = snapshot.val();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-msg';
            msgDiv.innerHTML = `<span class="chat-name">${msg.sender}:</span> ${msg.text}`;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // --- OYUN BAŞLATMA ---
        document.getElementById('startBtn').addEventListener('click', () => {
            const inputVal = document.getElementById('usernameInput').value;
            if(!inputVal.trim()) { alert("İsim yazmadan uçamazsın!"); return; }
            myName = inputVal;
            myPlayerId = 'pilot_' + Math.random().toString(36).substr(2, 5);
            
            // Tam ekran isteği
            toggleFullScreen();

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('radarContainer').style.display = 'block';
            document.getElementById('spectateControl').style.display = 'block';
            document.getElementById('chatContainer').style.display = 'flex';
            
            if(isMobile) {
                document.getElementById('mobileControls').style.display = 'block';
            } else {
                document.getElementById('pcControls').style.display = 'block';
            }
            
            playerRef = ref(db, 'players/' + myPlayerId);
            onDisconnect(playerRef).remove();
            
            const allPlayersRef = ref(db, 'players');
            onValue(allPlayersRef, (snapshot) => {
                const players = snapshot.val() || {};
                playersDataCache = players;

                Object.keys(players).forEach((key) => {
                    if (key === myPlayerId) return;
                    const pData = players[key];
                    if (!otherPlayers[key]) {
                        const enemyPlane = createPlaneMesh(0xff0000, 0x880000);
                        enemyPlane.userData = { 
                            targetPos: new THREE.Vector3(pData.x, pData.y, pData.z),
                            targetRot: new THREE.Quaternion().setFromEuler(new THREE.Euler(pData.rx, pData.ry, pData.rz))
                        };
                        scene.add(enemyPlane);
                        otherPlayers[key] = enemyPlane;
                    } else {
                        const enemy = otherPlayers[key];
                        enemy.userData.targetPos = new THREE.Vector3(pData.x, pData.y, pData.z);
                        enemy.userData.targetRot = new THREE.Quaternion().setFromEuler(new THREE.Euler(pData.rx, pData.ry, pData.rz));
                    }
                });
                Object.keys(otherPlayers).forEach((key) => {
                    if (!players[key]) { scene.remove(otherPlayers[key]); delete otherPlayers[key]; }
                });
            });
            gameActive = true;
            animate();
        });

        // --- YENİDEN BAŞLATMA BUTONU ---
        document.getElementById('restartBtn').addEventListener('click', () => {
             document.getElementById('gameOverScreen').style.display = 'none';
             resetGameVars();
             // Tekrar tam ekran deneyelim (kullanıcı etkileşimi olduğu için çalışır)
             toggleFullScreen();
        });

        let health = 100;
        let lastDamageTime = 0;
        let speed = 0;
        const keys = { w: false, up: false, down: false, left: false, right: false };
        const maxSpeed = 12.0, liftSpeed = 3.0;

        function resetGameVars() {
            speed = 0; health = 100; score = 0; flame.visible = false;
            keys.w = false; keys.up = false; keys.down = false; keys.left = false; keys.right = false;
            planeGroup.position.set(0, 2, 0); planeGroup.rotation.set(0, 0, 0);
            document.getElementById('scoreDisplay').innerText = 0;
            // updateHealthUI() animate'de var
        }

        function takeDamage(amount) {
            health -= amount; lastDamageTime = Date.now();
            document.getElementById('damageOverlay').style.opacity = 0.8;
            setTimeout(() => document.getElementById('damageOverlay').style.opacity = 0, 200);
            if(health <= 0) { 
                health = 0; 
                // ÖZEL GAME OVER EKRANI GÖSTER
                document.getElementById('gameOverScreen').style.display = 'flex';
                // Artık alert yok, tam ekran bozulmaz
            }
        }

        function updateHUD(currentName, currentScore, currentHealth, currentSpeed, currentAlt) {
            document.getElementById('pilotNameDisplay').innerText = "PİLOT: " + currentName.toUpperCase();
            document.getElementById('scoreDisplay').innerText = currentScore;
            document.getElementById('hpText').innerText = Math.round(currentHealth) + "%";
            document.getElementById('healthBar').style.width = currentHealth + "%";
            
            const bar = document.getElementById('healthBar');
            if(currentHealth > 50) bar.style.background = "linear-gradient(90deg, #00ff00, #aaff00)";
            else if(currentHealth > 20) bar.style.background = "linear-gradient(90deg, #ffa500, #ffcc00)";
            else bar.style.background = "linear-gradient(90deg, #ff0000, #ff5500)";

            document.getElementById('speedDisplay').innerText = Math.floor(currentSpeed * 120);
            document.getElementById('altDisplay').innerText = Math.floor(currentAlt - 2);
        }

        // --- KLAVYE KONTROLLERİ ---
        document.addEventListener('keydown', (e) => {
            if (document.activeElement === chatInput) return;
            if(e.key === 'w' || e.key === 'W') keys.w = true;
            if(e.key === 'ArrowUp') keys.up = true;
            if(e.key === 'ArrowDown') keys.down = true;
            if(e.key === 'ArrowLeft') keys.left = true;
            if(e.key === 'ArrowRight') keys.right = true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.key === 'w' || e.key === 'W') keys.w = false;
            if(e.key === 'ArrowUp') keys.up = false;
            if(e.key === 'ArrowDown') keys.down = false;
            if(e.key === 'ArrowLeft') keys.left = false;
            if(e.key === 'ArrowRight') keys.right = false;
        });

        // --- MOBİL KONTROLLER (DİNAMİK JOYSTICK) ---
        if(isMobile) {
            const touchZoneLeft = document.getElementById('touchZoneLeft');
            const dynamicJoystick = document.getElementById('dynamicJoystick');
            const dynamicKnob = document.getElementById('dynamicKnob');
            const throttleBtn = document.getElementById('throttleBtn');
            
            let joyCenterX, joyCenterY;
            const joyMaxRadius = 40; 
            let activeTouchId = null;

            touchZoneLeft.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.changedTouches[0];
                activeTouchId = touch.identifier;
                joyCenterX = touch.clientX;
                joyCenterY = touch.clientY;
                dynamicJoystick.style.left = joyCenterX + 'px';
                dynamicJoystick.style.top = joyCenterY + 'px';
                dynamicJoystick.style.display = 'block';
                dynamicKnob.style.transform = `translate(-50%, -50%)`;
            });

            touchZoneLeft.addEventListener('touchmove', (e) => {
                e.preventDefault();
                for (let i = 0; i < e.changedTouches.length; i++) {
                    if (e.changedTouches[i].identifier === activeTouchId) {
                        const touch = e.changedTouches[i];
                        moveJoystick(touch.clientX, touch.clientY);
                        break;
                    }
                }
            });

            touchZoneLeft.addEventListener('touchend', (e) => {
                e.preventDefault();
                for (let i = 0; i < e.changedTouches.length; i++) {
                    if (e.changedTouches[i].identifier === activeTouchId) {
                        dynamicJoystick.style.display = 'none';
                        activeTouchId = null;
                        keys.up = false; keys.down = false; keys.left = false; keys.right = false;
                        break;
                    }
                }
            });

            function moveJoystick(x, y) {
                let dx = x - joyCenterX;
                let dy = y - joyCenterY;
                const distance = Math.sqrt(dx*dx + dy*dy);
                if (distance > joyMaxRadius) {
                    const ratio = joyMaxRadius / distance;
                    dx *= ratio; dy *= ratio;
                }
                dynamicKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                const threshold = 10;
                keys.up = (dy < -threshold);
                keys.down = (dy > threshold);
                keys.left = (dx < -threshold);
                keys.right = (dx > threshold);
            }

            throttleBtn.addEventListener('touchstart', (e) => { e.preventDefault(); keys.w = true; throttleBtn.style.background = "rgba(255,0,0,0.6)"; });
            throttleBtn.addEventListener('touchend', (e) => { e.preventDefault(); keys.w = false; throttleBtn.style.background = "rgba(255,0,0,0.2)"; });
        }

        let frameCount = 0;

        function animate() {
            if(!gameActive) return;
            requestAnimationFrame(animate);

            // --- DELTA TIME (HIZ FARKINI ÖNLEMEK İÇİN) ---
            const delta = clock.getDelta(); // Geçen süre (saniye)
            // Ortalama 60FPS için bir çarpan. 
            // 0.016ms * 60 = ~1. 
            // Yani delta'yı sabit katsayılarla çarpmalıyız.
            const speedFactor = delta * 60; // 60 FPS'de 1 döner, 120FPS'de 0.5 döner ama 2 kere çalışır = 1.

            drawRadar();

            if (health > 0 && health < 100 && Date.now() - lastDamageTime > 10000) {
                health += 0.1 * speedFactor; 
            }

            // Diğer uçaklar için lag yumuşatma
            Object.keys(otherPlayers).forEach(key => {
                const enemy = otherPlayers[key];
                if(enemy.userData.targetPos) {
                    enemy.position.lerp(enemy.userData.targetPos, 0.1 * speedFactor);
                    enemy.quaternion.slerp(enemy.userData.targetRot, 0.1 * speedFactor);
                }
            });

            if (spectateId === null) {
                updateHUD(myName, score, health, speed, planeGroup.position.y);
            } else {
                const pData = playersDataCache[spectateId];
                if (pData) {
                    const sName = pData.name || "Bilinmiyor";
                    const sScore = pData.score || 0;
                    const sHealth = pData.health || 100;
                    const sSpeed = pData.speed || 0;
                    const sAlt = pData.y || 0;
                    updateHUD(sName, sScore, sHealth, sSpeed, sAlt);
                } else {
                     updateHUD("SİNYAL YOK", 0, 0, 0, 0);
                }
            }

            // --- HAREKET FİZİĞİ (DELTA TIME EKLENDİ) ---
            if (health > 0) {
                if (keys.w) { 
                    speed += 0.08 * speedFactor; // Hızlanma delta ile çarpıldı
                    flame.visible = true; 
                    flame.scale.setScalar(0.8 + Math.random()*0.4); 
                } else { 
                    flame.visible = false; 
                    speed -= 0.005 * speedFactor; 
                }
            } else { speed = 0; flame.visible = false; }

            if(speed > maxSpeed) speed = maxSpeed; 
            if(speed < 0) speed = 0;

            const oldPosition = planeGroup.position.clone();
            planeGroup.translateZ(-speed * speedFactor); // Hareket delta ile çarpıldı

            frameCount++;
            if(frameCount % 3 === 0 && playerRef) {
                set(playerRef, {
                    name: myName,
                    x: planeGroup.position.x,
                    y: planeGroup.position.y,
                    z: planeGroup.position.z,
                    rx: planeGroup.rotation.x,
                    ry: planeGroup.rotation.y,
                    rz: planeGroup.rotation.z,
                    score: score,
                    health: health,
                    speed: speed
                });
            }

            for (let i = collectables.length - 1; i >= 0; i--) {
                const item = collectables[i];
                item.rotation.x += 0.02 * speedFactor;
                const dist = planeGroup.position.distanceTo(item.position);
                if (dist < 25) {
                    score += item.userData.points;
                    showScorePopup(item.userData.points);
                    scene.remove(item); collectables.splice(i, 1);
                }
            }

            playerBox.setFromObject(planeGroup).expandByScalar(-1.0);
            if (planeGroup.position.y < 600) { 
                for (let box of buildingBoxes) {
                    if (playerBox.intersectsBox(box)) {
                        takeDamage(20);
                        planeGroup.position.copy(oldPosition);
                        planeGroup.translateZ(30); planeGroup.position.y += 150; planeGroup.rotation.set(0,0,0);
                        if (speed < liftSpeed) speed = liftSpeed;
                        const msg = document.getElementById('message');
                        msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2000);
                        break;
                    }
                }
            }

            // DÖNÜŞ HIZLARI (DELTA TIME UYGULANDI)
            if (speed > 0.5 && health > 0) {
                const turnSpeed = 0.02 * speedFactor;
                const rollSpeed = 0.03 * speedFactor;
                const yawSpeed = 0.015 * speedFactor;

                if(keys.up && planeGroup.rotation.x < 1.0) planeGroup.rotation.x += turnSpeed;
                if(keys.down && planeGroup.rotation.x > -1.0) planeGroup.rotation.x -= turnSpeed;
                if (keys.left) { planeGroup.rotateY(yawSpeed); if (planeGroup.rotation.z < 0.8) planeGroup.rotation.z += rollSpeed; } 
                else if (keys.right) { planeGroup.rotateY(-yawSpeed); if (planeGroup.rotation.z > -0.8) planeGroup.rotation.z -= rollSpeed; } 
                else {
                    // Düzeltme
                    if (planeGroup.rotation.z > 0.005) planeGroup.rotation.z -= yawSpeed;
                    else if (planeGroup.rotation.z < -0.005) planeGroup.rotation.z += yawSpeed;
                }
            }

            if (planeGroup.position.y > 2) {
                if (speed < liftSpeed) {
                    planeGroup.position.y -= 1.5 * (1 - speed/liftSpeed) * speedFactor;
                    if(planeGroup.rotation.x > -0.5) planeGroup.rotation.x -= 0.01 * speedFactor;
                }
            } else {
                if (planeGroup.position.y <= 2) {
                    planeGroup.position.y = 2;
                    if (planeGroup.rotation.x < -0.2) { takeDamage(10); speed = 0; }
                    if(speed < liftSpeed) { planeGroup.rotation.z *= 0.9; planeGroup.rotation.x *= 0.9; }
                }
            }

            let targetObj = planeGroup; 
            if (spectateId && otherPlayers[spectateId]) {
                targetObj = otherPlayers[spectateId];
            } else if (spectateId) {
                toggleCamera(); 
            }

            const targetPos = new THREE.Vector3(0, 12, 45).applyMatrix4(targetObj.matrixWorld);
            camera.position.lerp(targetPos, 0.1 * speedFactor); // Kamera yumuşaklığı da delta ile
            
            const lookAtPos = new THREE.Vector3(0, 0, -60).applyMatrix4(targetObj.matrixWorld);
            camera.lookAt(lookAtPos);

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
